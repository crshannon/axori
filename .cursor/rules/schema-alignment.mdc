---
description: "Database schema alignment patterns using drizzle-zod to maintain single source of truth between Drizzle schemas and Zod validation"
globs: ["packages/db/**", "packages/shared/src/validation/**", "apps/web/src/components/drawers/**", "apps/web/src/hooks/api/**", "apps/web/src/components/**/*Form*.tsx", "apps/web/src/components/**/*form*.tsx"]
alwaysApply: false
---

# Schema Alignment Pattern

## Core Principle: Single Source of Truth

**Drizzle schema is the single source of truth.** All Zod schemas are generated from Drizzle schemas using `drizzle-zod`, ensuring perfect alignment and eliminating drift.

## Architecture

```
Drizzle Schema (Source of Truth)
    ↓
    ├─→ Auto-generate Zod schemas (drizzle-zod)
    │       └─→ Enhance with custom validation rules
    │
    └─→ Infer TypeScript types (InferSelectModel/InferInsertModel)
            └─→ Export via @axori/shared
```

## Implementation Pattern

### 1. Define Drizzle Schema
Always start with the Drizzle schema definition:
```typescript
// packages/db/src/schema/index.ts
import { pgEnum } from "drizzle-orm/pg-core";

// Use pgEnum for enums (not text())
export const loanTypeEnum = pgEnum("loan_type", [
  "conventional", "fha", "va", ...
]);

export const loans = pgTable("loans", {
  id: uuid("id").defaultRandom().primaryKey(),
  loanType: loanTypeEnum("loan_type").notNull().default("conventional"),
  // ...
});
```

### 2. Generate Base Zod Schemas
Use `drizzle-zod` to generate base schemas automatically:
```typescript
// packages/shared/src/validation/base/loans.ts
import { createInsertSchema, createSelectSchema } from "drizzle-zod";
import { loans } from "@axori/db";

export const loanInsertSchema = createInsertSchema(loans);
export const loanSelectSchema = createSelectSchema(loans);
```

### 3. Create Enhanced Schemas for API
Create API-specific validation schemas that extend base schemas:
```typescript
// packages/shared/src/validation/enhanced/loans.ts
import { loanInsertSchema } from "../base/loans";
import { z } from "zod";

export const loanInsertApiSchema = loanInsertSchema.extend({
  // API expects interestRate as percentage (0-100)
  interestRate: z.number().min(0).max(100),
  // userId for authorization (not stored in loans table)
  userId: z.string().uuid(),
});
```

### 4. Export Types for Frontend
Export Zod-inferred types:
```typescript
// packages/shared/src/types/index.ts
import type { z } from "zod";
import { loanInsertApiSchema } from "../validation";

export type LoanInsertApi = z.infer<typeof loanInsertApiSchema>;
```

## Field Naming Conventions

Drizzle uses **camelCase** in code but maps to **snake_case** in the database:
```typescript
// Drizzle Schema (camelCase in code)
zipCode: text("zip_code").notNull(), // camelCase → snake_case
```

**Zod schemas generated by drizzle-zod automatically use camelCase** to match the code layer.

## Type Conversions

### Numeric Fields
Drizzle `numeric()` columns generate as `z.string()` in base schemas. Override in enhanced schemas:
```typescript
// Base schema (auto-generated)
originalLoanAmount: z.string(), // From Drizzle numeric()

// Enhanced schema (API-specific)
originalLoanAmount: z.number().min(0), // Override for API
```

### Enums
**Always use `pgEnum()` in Drizzle** - this ensures proper type safety:
```typescript
// ✅ Correct - Use pgEnum
export const loanTypeEnum = pgEnum("loan_type", ["conventional", "fha", ...]);

// ❌ Incorrect - Don't use text()
loanType: text("loan_type").notNull()
```

## Migration Workflow

When adding a new table or modifying an existing one:

1. **Update Drizzle Schema** (`packages/db/src/schema/index.ts`)
2. **Generate Base Schemas** using `createInsertSchema()` and `createSelectSchema()`
3. **Create Enhanced Schemas** (`packages/shared/src/validation/enhanced/`)
4. **Export Types** (`packages/shared/src/types/index.ts`)
5. **Update API Routes** to use enhanced schemas
6. **Generate Migration**: `pnpm --filter @axori/db db:generate`
7. **Apply Migration**: `pnpm --filter @axori/db db:migrate`

## References

- Full Guide: `.skills/architect/drizzle-zod-alignment.md`
- Pattern Documentation: `docs/architecture/SCHEMA_ALIGNMENT_PATTERN.md`
- Type Inference: `.skills/architect/type-inference-patterns.md`
